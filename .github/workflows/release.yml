name: StartTunnel DEB Package Builder

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      start_os_branch:
        description: 'Start-OS branch to build from'
        required: false
        default: 'next/major'
        type: string
      prerelease:
        description: 'Publish as pre-release'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag_exists: ${{ steps.check-tag.outputs.exists }}
      tag_name: ${{ steps.get-tag.outputs.tag_name }}
      start_os_branch: ${{ steps.get-branch.outputs.branch }}
      prerelease: ${{ steps.get-prerelease.outputs.prerelease }}
    steps:
      - name: Determine start-os branch
        id: get-branch
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH="${{ github.event.inputs.start_os_branch }}"
          else
            BRANCH="next/major"
          fi
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Using start-os branch: $BRANCH"

      - name: Determine pre-release flag
        id: get-prerelease
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            PRERELEASE="true"
          fi
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "Pre-release: $PRERELEASE"

      - name: Checkout start-os
        uses: actions/checkout@v4
        with:
          repository: start9labs/start-os
          ref: fix-permissions
          path: start-os
          submodules: recursive

      - name: Extract version from Cargo.toml
        id: get-version
        run: |
          VERSION=$(grep -m 1 'version = ' ./start-os/core/startos/Cargo.toml | sed 's/version = "\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Determine tag name
        id: get-tag
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            # Use the tag that was pushed
            TAG_NAME="${{ github.ref_name }}"
          else
            # Extract from Cargo.toml for workflow_dispatch
            TAG_NAME="v${{ steps.get-version.outputs.version }}"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: Check if tag exists
        id: check-tag
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag exists (triggered by tag push)"
          else
            if git ls-remote --tags https://github.com/${{ github.repository }} | grep -q "refs/tags/${{ steps.get-tag.outputs.tag_name }}"; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "Tag already exists in repository"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "Tag does not exist yet"
            fi
          fi

      - name: Create tag if needed
        if: ${{ github.event_name == 'workflow_dispatch' && steps.check-tag.outputs.exists == 'false' }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} repo
          cd repo
          git tag ${{ steps.get-tag.outputs.tag_name }}
          git push origin ${{ steps.get-tag.outputs.tag_name }}
          echo "Created tag: ${{ steps.get-tag.outputs.tag_name }}"

  build:
    name: Build ${{ matrix.arch }}
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            os: ubuntu-22.04
          - arch: aarch64
            os: ubuntu-22.04-arm
          - arch: riscv64
            os: ubuntu-22.04-arm

    steps:
      - name: Checkout start-os
        uses: actions/checkout@v4
        with:
          repository: start9labs/start-os
          ref: ${{ needs.prepare.outputs.start_os_branch }}
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.11.0"

      - name: Set up docker QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure sccache
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_RESULTS_URL', process.env.ACTIONS_RESULTS_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Build DEB package
        env:
          PLATFORM: ${{ matrix.arch }}
          SCCACHE_GHA_ENABLED: on
          SCCACHE_GHA_VERSION: 0
        run: |
          make tunnel-deb

      - name: Generate SHA256 checksum
        run: |
          cd results
          for deb in start-tunnel-*_${{ matrix.arch }}.deb; do
            sha256sum "$deb" > "${deb}.sha256"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-${{ matrix.arch }}
          path: |
            results/start-tunnel-*_${{ matrix.arch }}.deb
            results/start-tunnel-*_${{ matrix.arch }}.deb.sha256

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-packages-*
          path: release-packages
          merge-multiple: true

      - name: Verify artifacts and combine checksums
        working-directory: release-packages
        run: |
          echo "Downloaded packages:"
          find . -name "*.deb" -exec ls -lh {} \;
          find . -name "*.sha256" -exec cat {} \; > sha256sums.txt
          echo "SHA256 checksums:"
          cat sha256sums.txt

      - name: Generate release notes
        working-directory: release-packages
        run: |
          TAG_NAME="${{ needs.prepare.outputs.tag_name }}"
          echo "## StartTunnel $TAG_NAME" > release-notes.txt
          echo "" >> release-notes.txt
          echo "### DEB Packages" >> release-notes.txt
          echo "" >> release-notes.txt
          echo "This release includes DEB packages for the following architectures:" >> release-notes.txt
          echo "- x86_64" >> release-notes.txt
          echo "- aarch64" >> release-notes.txt
          echo "- riscv64" >> release-notes.txt
          echo "" >> release-notes.txt
          echo "### SHA256 Checksums" >> release-notes.txt
          echo '```' >> release-notes.txt
          cat sha256sums.txt >> release-notes.txt
          echo '```' >> release-notes.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-packages/**/*.deb
            release-packages/sha256sums.txt
          name: StartTunnel ${{ needs.prepare.outputs.tag_name }}
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          body_path: release-packages/release-notes.txt
          prerelease: ${{ needs.prepare.outputs.prerelease == 'true' }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
